{% extends 'base.html' %}
{% block title %}Ask Doubts · StudyAssistant{% endblock %}

{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
  :root{
    --ink:#e7e7e7; --muted:#bfc6d0;
    --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.14);
    --accent:#ffeb3b; --accent-2:#ffd600;
  }

  html, body{
    margin:0; padding:0; height:100%;
    background:
      radial-gradient(1200px 620px at 16% -12%, rgba(255,235,59,.12), transparent 50%),
      radial-gradient(1000px 680px at 115% 20%, rgba(255,235,59,.08), transparent 55%),
      linear-gradient(135deg,#111827,#0b1020 60%);
    font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--ink); overflow-x:hidden;
  }

  .wrap{
    min-height:calc(100vh - 65px);
    display:flex; justify-content:center; align-items:flex-start;
    padding:80px 16px 120px; /* bottom padding for composer */
  }

  .card{
    width:100%; max-width:960px; position:relative;
    background:var(--panel); border:1px solid var(--border); border-radius:20px;
    box-shadow:0 15px 45px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.04);
    backdrop-filter:blur(14px); overflow:hidden; animation:pop .45s ease;
  }
  .card::before{
    content:""; position:absolute; inset:-60% -60% auto auto; width:220%; height:220%;
    background:conic-gradient(from 0deg, var(--accent), var(--accent-2), var(--accent));
    opacity:.05; animation:spin 12s linear infinite;
  }
  .card > *{position:relative; z-index:1}

  header{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:18px 22px; border-bottom:1px solid var(--border);
  }
  .h-left{display:flex; align-items:center; gap:12px}
  .dot{width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 10px var(--accent)}
  h2{margin:0; font-weight:800; letter-spacing:.3px; color:var(--accent); text-shadow:0 0 10px rgba(255,235,59,.45)}
  .subtle{color:var(--muted); font-size:12px}

  /* Chat area */
  .chat{
    max-height:65vh; overflow:auto; padding:18px; display:flex; flex-direction:column; gap:12px;
    scroll-behavior:smooth;
  }
  .chat::-webkit-scrollbar{width:8px}
  .chat::-webkit-scrollbar-thumb{background:rgba(255,255,255,.25);border-radius:8px}

  .msg{
    max-width:80%; padding:12px 14px; border-radius:16px; line-height:1.55; font-size:14px;
    display:inline-flex; gap:10px; align-items:flex-start; box-shadow:0 8px 20px rgba(0,0,0,.25);
    border:1px solid rgba(255,255,255,.12);
  }
  .msg .bubble{flex:1}
  .msg .meta{font-size:11px; color:var(--muted); margin-top:6px}
  .msg .tools{display:flex; gap:8px; margin-top:6px}
  .tool{background:transparent; color:var(--ink); border:1px dashed rgba(255,255,255,.3);
        padding:4px 8px; border-radius:999px; font-size:11px; cursor:pointer}
  .tool:hover{border-color:#fff}

  .ai{align-self:flex-start; background:rgba(255,255,255,.10)}
  .user{align-self:flex-end; background:linear-gradient(180deg,var(--accent-2),var(--accent)); color:#1b1b1b; border-color:rgba(0,0,0,.15)}

  .typing{display:inline-flex; gap:6px}
  .typing span{
    width:6px; height:6px; border-radius:50%; background:var(--accent);
    box-shadow:0 0 8px rgba(255,235,59,.6); display:inline-block; animation:bounce 1.2s infinite ease-in-out;
  }
  .typing span:nth-child(2){animation-delay:.15s}
  .typing span:nth-child(3){animation-delay:.3s}

  /* Composer (fixed) */
  .composer{
    position:fixed; left:0; right:0; bottom:0; z-index:999;
    background:linear-gradient(180deg, rgba(17,24,39,.8), rgba(11,16,32,.9));
    border-top:1px solid var(--border); backdrop-filter:blur(10px);
    padding:10px 0;
  }
  .composer form{
    display:flex; gap:10px; align-items:flex-end; max-width:960px; margin:0 auto; padding:0 16px;
  }
  .composer textarea{
    flex:1; min-height:44px; max-height:140px; resize:none;
    padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.08); color:#fff; outline:none; font-size:14px;
  }
  .composer textarea:focus{
    box-shadow:0 0 12px rgba(255,235,59,.45), inset 0 0 6px rgba(0,0,0,.25);
    background:rgba(255,255,255,.12)
  }
  .send{
    padding:12px 16px; border:none; border-radius:12px; font-weight:900; cursor:pointer;
    background:linear-gradient(180deg,var(--accent-2),var(--accent)); color:#1b1b1b;
    border:1px solid rgba(0,0,0,.15); box-shadow:0 10px 22px rgba(255,235,59,.35); transition:.18s ease;
  }
  .send:hover{transform:translateY(-1px) scale(1.01)}
  .send[disabled]{opacity:.7; cursor:not-allowed; box-shadow:none}

  /* Jump to bottom */
  .jump{
    position:fixed; right:16px; bottom:88px; z-index:998;
    display:none; padding:8px 12px; border-radius:999px; font-weight:800; font-size:12px;
    background:rgba(255,255,255,.12); color:var(--ink); border:1px solid var(--border); cursor:pointer;
    backdrop-filter:blur(10px)
  }
  .jump:hover{border-color:#fff}

  @keyframes pop{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes bounce{
    0%,80%,100%{transform:scale(.6);opacity:.7}
    40%{transform:scale(1);opacity:1}
  }
</style>

<div class="wrap">
  <div class="card">
    <header>
      <div class="h-left">
        <span class="dot"></span>
        <h2>Ask Doubts</h2>
      </div>
      <div class="subtle">Answers are grounded in your uploaded notes (RAG)</div>
    </header>

    <div class="chat" id="chat">
      <div class="msg ai">
        <div class="bubble">
          <div>Hi! Ask anything from your notes. I’ll cite concepts based on your material.</div>
          <div class="meta" data-time></div>
        </div>
      </div>
    </div>
  </div>
</div>

<button class="jump" id="jump">▼ New reply</button>

<!-- Composer -->
<div class="composer">
  <form id="askForm">
    {% csrf_token %}
    <textarea id="question" name="question" placeholder="Type your doubt… (Shift+Enter for newline)" required></textarea>
    <button class="send" id="sendBtn" type="submit">Ask</button>
  </form>
</div>

<script>
  const chat = document.getElementById('chat');
  const form = document.getElementById('askForm');
  const textarea = document.getElementById('question');
  const sendBtn = document.getElementById('sendBtn');
  const jump = document.getElementById('jump');

  function csrf(){ return document.querySelector('input[name="csrfmiddlewaretoken"]').value; }
  function now(){ return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
  function atBottom(){ return chat.scrollHeight - chat.scrollTop - chat.clientHeight < 10; }
  function scrollToBottom(){ chat.scrollTop = chat.scrollHeight; }

  // Auto-resize textarea
  function autosize(){
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 140) + 'px';
  }
  textarea.addEventListener('input', autosize);
  autosize();

  // Show "jump to bottom" when user scrolls up and new content arrives
  chat.addEventListener('scroll', () => {
    if (atBottom()) jump.style.display = 'none';
  });
  jump.addEventListener('click', () => { scrollToBottom(); jump.style.display = 'none'; });

  function addMsg(role, text, isTyping=false){
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + (role === 'user' ? 'user' : 'ai');

    const bubble = document.createElement('div');
    bubble.className = 'bubble';

    const content = document.createElement('div');
    content.className = isTyping ? 'typing' : '';
    if (isTyping){
      content.innerHTML = '<span></span><span></span><span></span>';
    } else {
      content.textContent = text;
    }
    bubble.appendChild(content);

    const meta = document.createElement('div');
    meta.className = 'meta'; meta.textContent = now();
    bubble.appendChild(meta);

    // Tools only for AI answers (copy)
    if (!isTyping && role === 'ai'){
      const tools = document.createElement('div');
      tools.className = 'tools';
      const copyBtn = document.createElement('button');
      copyBtn.type = 'button'; copyBtn.className = 'tool'; copyBtn.textContent = 'Copy';
      copyBtn.addEventListener('click', async () => {
        try { await navigator.clipboard.writeText(text); copyBtn.textContent = 'Copied ✓'; setTimeout(()=>copyBtn.textContent='Copy', 1000); }
        catch { copyBtn.textContent = 'Failed'; setTimeout(()=>copyBtn.textContent='Copy', 1000); }
      });
      tools.appendChild(copyBtn);
      bubble.appendChild(tools);
    }

    wrap.appendChild(bubble);
    chat.appendChild(wrap);
    if (atBottom()) scrollToBottom(); else jump.style.display = 'block';
    return {wrap, bubble, content};
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const q = textarea.value.trim();
    if (!q) return;

    // User message
    addMsg('user', q);
    textarea.value=''; autosize();

    // Typing placeholder
    const typing = addMsg('ai', '', true);
    sendBtn.disabled = true;

    try{
      const res = await fetch("{% url 'ask_doubt' %}", {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken': csrf()},
        body: new URLSearchParams({question: q})
      });

      const data = await res.json();
      const answer = data && data.answer ? data.answer : "⚠️ I couldn't find an answer in your notes.";
      // swap typing with real text
      typing.content.className = ''; typing.content.textContent = answer;
      // add copy tool
      const tools = document.createElement('div');
      tools.className = 'tools';
      const copyBtn = document.createElement('button');
      copyBtn.type = 'button'; copyBtn.className = 'tool'; copyBtn.textContent = 'Copy';
      copyBtn.addEventListener('click', async () => {
        try { await navigator.clipboard.writeText(answer); copyBtn.textContent = 'Copied ✓'; setTimeout(()=>copyBtn.textContent='Copy', 1000); }
        catch { copyBtn.textContent = 'Failed'; setTimeout(()=>copyBtn.textContent='Copy', 1000); }
      });
      tools.appendChild(copyBtn);
      typing.bubble.appendChild(tools);

    } catch (err){
      typing.content.className=''; typing.content.textContent = "⚠️ Network error. Please try again.";
    } finally {
      sendBtn.disabled = false;
      if (!atBottom()) jump.style.display = 'block'; else scrollToBottom();
    }
  });

  // Enter to send, Shift+Enter for newline
  textarea.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      form.dispatchEvent(new Event('submit', {cancelable:true}));
    }
  });

  // Inject times on initial AI message
  document.querySelectorAll('[data-time]').forEach(el => el.textContent = now());
</script>
{% endblock %}






