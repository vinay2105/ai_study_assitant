{% extends 'base.html' %}
{% block title %}Your AI Generated Notes ¬∑ StudyAssistant{% endblock %}

{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

  :root{
    --ink:#e7e7e7; --muted:#bfc6d0;
    --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.14);
    --accent:#ffeb3b; --accent-2:#ffd600;
  }

  body{
    margin:0; padding:0;
    background:
      radial-gradient(1200px 620px at 16% -12%, rgba(255,235,59,.12), transparent 50%),
      radial-gradient(1000px 680px at 115% 20%, rgba(255,235,59,.08), transparent 55%),
      linear-gradient(135deg,#111827,#0b1020 60%);
    font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink);
  }

  .page{
    min-height:calc(100vh - 65px);
    display:flex; align-items:flex-start; justify-content:center;
    padding:90px 16px 40px;
  }

  .card{
    width:100%; max-width:980px; position:relative;
    background:var(--panel); border:1px solid var(--border); border-radius:20px;
    box-shadow:0 15px 45px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.04);
    backdrop-filter:blur(14px); overflow:hidden; animation:pop .45s ease;
  }
  .card::before{
    content:""; position:absolute; inset:-60% -60% auto auto; width:220%; height:220%;
    background:conic-gradient(from 0deg, var(--accent), var(--accent-2), var(--accent));
    opacity:.05; animation:spin 12s linear infinite;
  }
  .card > *{position:relative; z-index:1}

  header{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:18px 22px; border-bottom:1px solid var(--border);
  }
  .h-left{display:flex; align-items:center; gap:12px}
  .dot{width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 10px var(--accent)}
  h2{margin:0; font-weight:800; letter-spacing:.3px; color:var(--accent); text-shadow:0 0 10px rgba(255,235,59,.45)}
  .subtle{color:var(--muted); font-size:12px}

  .body{padding:18px}

  #notes-container{
    height:70vh; overflow:auto; padding:16px 18px; border-radius:14px;
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));
    border:1px solid var(--border); box-shadow:inset 0 0 0 1px rgba(255,255,255,.03);
    font-size:15px; line-height:1.65;
  }
  #notes-container::-webkit-scrollbar{width:8px}
  #notes-container::-webkit-scrollbar-thumb{background:rgba(255,255,255,.25);border-radius:8px}
  #notes-container h1,#notes-container h2,#notes-container h3{
    color:var(--accent); margin:1rem 0 .5rem; font-weight:800; text-shadow:0 0 8px rgba(255,235,59,.45)
  }
  #notes-container p{margin:.4rem 0}
  #notes-container ul{list-style:none; padding-left:0; margin:.3rem 0 .6rem}
  #notes-container li{position:relative; padding-left:1.2rem; margin:.25rem 0}
  #notes-container li::before{
    content:""; position:absolute; left:.2rem; top:.55rem; width:.45rem; height:.45rem; border-radius:50%;
    background:linear-gradient(180deg,var(--accent-2),var(--accent)); box-shadow:0 0 8px rgba(255,235,59,.5)
  }
  #notes-container blockquote{
    margin:.6rem 0; padding:.6rem .8rem; border-left:3px solid var(--accent); background:rgba(255,255,255,.06); border-radius:8px
  }
  #notes-container pre, #notes-container code{
    font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:13px;
  }
  #notes-container pre{
    background:rgba(20,20,28,.65); border:1px solid rgba(255,255,255,.12); padding:10px 12px; border-radius:10px; overflow:auto
  }
  #notes-container table{
    width:100%; border-collapse:separate; border-spacing:0; margin:.6rem 0; font-size:14px
  }
  #notes-container th, #notes-container td{
    padding:8px 10px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05)
  }
  #notes-container th{color:var(--accent); font-weight:800}

  .word{opacity:0; display:inline-block; white-space:pre; text-shadow:0 0 6px rgba(255,235,59,.35); transition:opacity .1s ease-in}
  .word.visible{opacity:1}

  .button-group{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:14px}
  .action-btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    background:linear-gradient(180deg,var(--accent-2),var(--accent)); color:#1b1b1b;
    font-weight:900; border-radius:12px; padding:12px 16px; border:1px solid rgba(0,0,0,.15);
    box-shadow:0 10px 22px rgba(255,235,59,.35); font-size:14px; cursor:pointer; text-decoration:none; transition:.18s ease;
  }
  .action-btn:hover{transform:translateY(-1px) scale(1.01)}

  #quiz-loading{color:var(--accent); font-size:13px; margin-top:10px; text-align:center; display:none}
  #quiz-loading::before{
    content:""; width:12px; height:12px; margin-right:6px; display:inline-block;
    border:2px solid rgba(255,255,255,.3); border-top:2px solid var(--accent); border-radius:50%;
    animation:spin 1s linear infinite; vertical-align:middle
  }

  @keyframes pop{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>

<div class="page">
  <div class="card">
    <header>
      <div class="h-left">
        <span class="dot"></span>
        <h2>Your AI Generated Notes</h2>
      </div>
      <div class="subtle">Rendered from your upload ¬∑ ready to review</div>
    </header>

    <div class="body">
      <div id="notes-container"></div>

      <div class="button-group">
        <button type="button" id="download-btn" class="action-btn" data-filename="AI_Notes.pdf">üìÑ Download as PDF</button>

        <form method="GET" action="{% url 'generate_quiz' %}" onsubmit="startQuizLoading()" style="margin:0">
          <button type="submit" id="quiz-btn" class="action-btn">üìù Start Quiz</button>
        </form>

        <a href="{% url 'ask_doubt' %}" class="action-btn">üí¨ Ask Doubt</a>
      </div>

      <div id="quiz-loading">Generating Quiz... Please wait ‚è≥</div>
    </div>
  </div>
</div>

<!-- jsPDF (no SRI to avoid blocking) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  // Render Notes
  let rawHTML = `{{ generated_notes|escapejs }}`.trim();
  if (rawHTML.startsWith("```")) {
    rawHTML = rawHTML.replace(/^```[a-zA-Z]*\n?/, '').replace(/```$/, '');
  }
  const container = document.getElementById('notes-container');
  container.innerHTML = rawHTML;

  // Word animation
  const elements = container.querySelectorAll('*');
  let delay = 0;
  elements.forEach(el => {
    if (el.childNodes.length === 1 && el.childNodes[0].nodeType === 3) {
      const text = el.innerText;
      el.innerHTML = '';
      text.split(/(\s+)/).forEach(word => {
        const span = document.createElement('span');
        span.textContent = word;
        span.className = 'word';
        el.appendChild(span);
        setTimeout(() => span.classList.add('visible'), delay);
        delay += 30;
      });
    }
  });

  // Download as PDF
  document.getElementById('download-btn').addEventListener('click', function (e) {
    e.preventDefault();
    const JsPdfCtor = (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : window.jsPDF;
    if (!JsPdfCtor) {
      alert('PDF library failed to load. Please refresh the page and try again.');
      return;
    }

    const doc = new JsPdfCtor({ unit: 'pt', format: 'a4' });
    const marginLeft = 40, marginTop = 60, lineHeight = 18;
    const pageH = doc.internal.pageSize.height;
    const maxW = doc.internal.pageSize.width - marginLeft * 2;

    const text = (container.innerText || container.textContent || '').trim();
    const lines = doc.splitTextToSize(text, maxW);

    let y = marginTop;
    doc.setFont('helvetica','normal');
    doc.setFontSize(11);

    lines.forEach(line => {
      if (y > pageH - 40) {
        doc.addPage();
        y = marginTop;
      }
      doc.text(line, marginLeft, y);
      y += lineHeight;
    });

    const fname = this.dataset.filename || 'AI_Notes.pdf';
    doc.save(fname);
  });

  // Show loading when quiz starts
  function startQuizLoading(){
    const quizBtn = document.getElementById('quiz-btn');
    const loadingText = document.getElementById('quiz-loading');
    quizBtn.disabled = true;
    quizBtn.textContent = 'Generating Quiz...';
    loadingText.style.display = 'block';
  }
</script>
{% endblock %}















